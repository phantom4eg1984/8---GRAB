# Домашнее задание по теме: Загрузка системы.
## 1. Попасть в систему без пароля несколькими способами.
В зависимости от системы порядок сброса пароля может отличаться, задание выполнялось на Centos 7.

### Способ 1 (init=/bin/sh):

При начальной загрузки системы нажимаем кнопку ```e(edit)```, после этого попадаем в меню ```grub``` которое можем отредактировать.
В пункте меню который начинается с ```linux16``` в секции ```fi``` в конце строки добавляем ```init=/bin/sh```. После этого нажимаем ```Ctrl+X``` и загружаемся в систему.
В систему мы должны попасть без ввода пароля root. Теперь мы можем изменить пароль.

Наша файловая система подмонтирована в режиме для чтения, нам необходимо перемонтировать ее в режим для записи, для этого вводим команду:
```mount -o remount,rw /```  или можно в ```grub``` заменить параметры монтирования с ```ro``` на ```rw``` в строке которая начинается с ```linux16```

Проверяем что наша система смонтировалась в режиме для редактирования и мы можем вносить изменения:
```
mount | grep sda
```

Меняем пароль:
```
passwd
```

Если мы сейчас перезагрузимся поскольку у нас включен ```Selinux``` мы не сможем войти под новым паролем, поэтому надо ему дать понять что требуется перечитать контекст. Для этого создаем новый файл.
```
touch /.autorelabel
```

Сбросим данные из кеша на диск на всякий случай:
```
sync
```

Перезагружаем систему:
```
exec /sbin/init
```

### Способ 2 (rd.break):

При начальной загрузки системы нажимаем кнопку ```e(edit)```, после этого попадаем в меню ```grub``` которое можем отредактировать.
В пункте меню который начинается с ```linux16``` в секции ```fi``` в конце строки добавляем ```rd.break```. После этого нажимаем ```Ctrl+X``` и загружаемся в ```Emergency recovery mode```.
В систему мы должны попасть без ввода пароля root. Теперь мы можем изменить пароль.

Наша файловая система подмонтирована в режиме для чтения, нам необходимо перемонтировать ее в режим для записи, для этого вводим команду:
```mount -o remount,rw /```  или можно в ```grub``` заменить параметры монтирования с ```ro``` на ```rw``` в строке которая начинается с ```linux16```

Проверяем что наша система смонтировалась в режиме для редактирования и мы можем вносить изменения:
```
mount | grep sda
```
Меняем пароль:
```
chroot /sysroot
passwd
```

Если мы сейчас перезагрузимся поскольку у нас включен ```Selinux``` мы не сможем войти под новым паролем, поэтому надо ему дать понять что требуется перечитать контекст. Для этого создаем новый файл.
```
touch /.autorelabel
```

Сбросим данные из кеша на диск на всякий случай:
```
sync
```
Вводим команду ```exit``` **2 раза**, после чего система перезагрузится.

## 2. Установить систему с LVM, после чего переименовать VG.

Оцениваем состояние системы:
```
[root@centos8 ~]# lsblk
NAME                         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sda                            8:0    0   20G  0 disk 
├─sda1                         8:1    0    1G  0 part /boot
└─sda2                         8:2    0   19G  0 part 
  ├─centos8-root 253:0    			  0   17G  0 lvm  /
  └─centos8-swap 253:1                0    2G  0 lvm  [SWAP]
```
```
[root@centos8 ~]# vgs
  VG                  #PV #LV #SN Attr   VSize   VFree
  centos8              1   2   0 wz--n- <19.00g    0 
```

Переименовывем Volume Group:
```
[root@centos8 ~]# vgrename centos8 OTUS
  Volume group "centos8" successfully renamed to "OTUS"
```

Редактируем файлы ```/etc/fstab, /etc/default/grub, /boot/grub2/grub.cfg```. Во всех файлах исправляем старое название Volume Group на новое.

Пересоздаем ```initrd image```, что бы наша система знала новое название Volume Group.
```
[root@centos8 ~]# mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)
```

Перезагружаемся и проверяем что все было выполнено успешно.
```
[root@centos8 ~]# vgs
  VG                  #PV #LV #SN Attr   VSize   VFree
  OTUS                 1   2   0 wz--n- <19.00g    0 
```

## 3. Добавить модуль в initrd:
В каталоге где хранятся скрипты модулей ```/usr/lib/dracut/modules.d/``` создаем новый каталог ```01test```, в нем создаем 2 скрипта:
```module-setup.sh``` - устанавливает модуль и запускает скрипт test.sh

```test.sh``` - рисует пингвинчика

### module-setup.sh:
```
#!/bin/bash

check() {
    return 0
}

depends() {
    return 0
}

install() {
    inst_hook cleanup 00 "${moddir}/test.sh"
}
```

### test.sh:
```
#!/bin/bash

exec 0<>/dev/console 1<>/dev/console 2<>/dev/console
cat <<'msgend'
Hello! You are in dracut module!
 ___________________
< Hello OTUS 2023!!! >
 -------------------
   \
    \
        .--.
       |o_o |
       |:_/ |
      //   \ \
     (|     | )
    /'\_   _/`\
    \___)=(___/
msgend
sleep 10
echo " continuing...."
```

Пересобираем ```initrd image``` командой:
```
mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)
```

Перезагружаемся. Во время загрузки нажимаем ```e``` и переходим к редактированию параметров загрузки.
В строке начинающуюся с ```linux16``` убираем параметры ```rghb``` и ```quiet```. Нажимаем ```Ctrl+X```.
Система продолжит загружаться и мы увидим вывод пингвина. :+1:
